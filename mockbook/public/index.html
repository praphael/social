<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mockbook</title>
    <link rel="stylesheet" href="bootstrap.min.css">
</head>
<body>
    <script src="bootstrap.bundle.js"></script>
    <header><h3 class="mb-3 mt-3 ms-3">Mockbook</h3></header>
    <main> <!--- style="background-color: darkorchid"> -->

    <!--- Login -->
    <div id="loginform" class="container">
        <div class="col-lg-4"></div>
        <form class="container col-lg-4">
            <div class="row mb-3">
                <label class="form-label col-auto" for="loginusername">Username:</label>
                <input class="form-control input-md col-md-2" type="text" id="loginusername">
                <span class="col-lg-6"></span>
            </div>
            <div class="row mb-3">
                <label class="form-label col-auto" for="loginpassword">Password:</label>
                <input class="form-control input-md col-md-2" type="password" id="loginpassword">
                <span class="col-lg-6"></span>
            </div>  
            <div class="row mb-3">
                <button class="col-md-4 btn btn-primary" type="button" onclick="login()">Login</button>
                <span class="col-lg-6"></span>
            </div>
            <div class="row mt-3">
                <span class="col-sm-4 me-1 mb-1">New User?</span>
                <button class="col-sm-4 btn btn-link" type="button" onclick="changeState('register')">Register</button>
                <span class="col-lg-6"></span>
            </div>
            <div id="loginresp" hidden></div>
        </form>
        <div class="col-lg-4"></div>
    </div> <!--- login form-->

    <div id="regform" class="container">
        <div class="col-md-4"></div>
        <form class="col-md-4 container">
            <div class="row mb-3">
                <label class="form-label" for="username">Desired Username:</label>
                <input class="form-control" type="text" id="newusername" name="newusername">
            </div>
            <div class="row mb-3">
                <label class="form-label" for="username">Email address:</label>
                <input class="form-control" type="text" id="newuseremail" name="newuseremail">
            </div>
            <div class="row mb-3">
                <label class="form-label" for="password">Desired Password:</label>
                <input class="form-control" type="password" id="newpassword" name="newpassword">
            </div>
            <div class="row mb-3">
                <label class="form-label" for="newpassword2">Re-enter Password:</label>
                <input class="form-control" type="password" id="newpassword2" name="newpassword2">
            </div>
            <div class="row mt-3">
                <button class="col-md-4 btn btn-primary" type="button" onclick="register()">Register</button>
                <span class="col-lg-4"></span>
            </div>
            <div class="row mt-3">
                <span class="col-sm-4 me-1 mb-1">Already regsitered?</span>
                <button class="col-sm-4 btn btn-link" onclick="changeState('login')">Login</button>
                <span class="col-lg-6"></span>
            </div>
            <div id="regresp" hidden></div>
        </form>
        <div class="col-md-4"></div>
    </div>

    <div id="feedDiv" class="container"> <!--- style="background-color: lightcoral"> -->
        <!--- Post area --->
        <div class="row mb-3">
            <form id="post" class="col-10">
            <div class="container-fluid"><div class="row"> <!--- style="background-color: aquamarine" --->
                <div class="col-auto"><label class="form-label" for="text">Say something:</label></div>
                <div class="col-8"><input class="form-control" type="text" id="newPostText">
                </div>
                <!--- <div id="postresp" name="postresp" hidden></div> --->
                <div class="col-auto"><button class="col-auto btn btn-primary" onclick="postNew()" type="button">Post</button></div>
            </div></div>
            </form>
            <div class="col-2"><button class="btn btn-secondary" onclick="logout()">Logout</button></div>
        </div>
        <div class="row">
            <div class="col-2 me-2">
            <!---  users -->
            <div class="container-fluid" id="users">Users list</div> <!--- style="background-color: azure" --->
            </div>
            <div class="col-9">
            <!---  feed -->
            <div class="container-fluid" id="feed">Feed area</div>  <!--- style="background-color: rgb(122, 122, 118)"  --->
            </div>
        </div>
    </div>
    </main>
    <script>
        function changeState(state) {
            console.log("state= ", state);
            
            regForm = document.getElementById("regform");
            loginForm = document.getElementById("loginform");
            feed = document.getElementById("feed");
            users = document.getElementById("users");
            feedDiv = document.getElementById("feedDiv");
            post = document.getElementById("post");
            feedDiv.hidden = true;
            regForm.hidden = true;
            loginForm.hidden = true;

            if(state == "login") {
                loginForm.hidden = false;
            }
            else if (state == "feed") {
                feedDiv.hidden = false;
                appState.lastupdate = 0;
                setTimeout("getFeed()", 0);
                setTimeout("getUserList()", 0);
           }
            else if (state == "register") {
                regForm.hidden = false;
            }
        }
        
        appState = { token : "", lastupdate : 0 }; 
        appState.token = sessionStorage.getItem("token");
        appState.feed = [];
        appState.feedMap = new Map();
        appState.newMessages = [];
        appState.userList = [];
        appState.username = null;
        appState.firstRender = true;

        if (appState.token) {
            changeState("feed");
        } else {
            changeState("login");
        }

        
        document.getElementById("loginpassword").addEventListener('keydown', async (e) => {
            console.log("loginpassword: ", e.code);
        });
        document.getElementById("newPostText").addEventListener('keydown', async (e) => {
            console.log("newPostText: ", e.code);
        });
        
        async function login() {
            console.log("login");
            const userData = {
                username: document.getElementById("loginusername").value,
                password: document.getElementById("loginpassword").value
            };

            try {
                sessionStorage.clear();
                appState.lastupdate = 0;
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    console.log(`login response ok`);
                    const j = await response.json();
                    console.log(`successful login token=${j.token}`);
                    sessionStorage.setItem("token", j.token);
                    appState.username = userData.username;
                    appState.token = j.token;
                    changeState("feed");
                } else {
                    const errorMessage = await response.text();
                    console.log(errorMessage);
                    alert(`Error: ${errorMessage}`);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        };

        function logout() {
            appState.token = "";
            appState.lastupdate = 0;
            appState.feed = [];
            appState.feedMap = new Map();
            appState.userList = [];
            appState.newMessages = [];
            appState.firstRender = true;
            appState.username = null;
            sessionStorage.clear();
            changeState("login");
        }

        async function postReply(author, tm, origauthor, origtm) {
            const replyToData = {
                origauthor: origauthor,
                origtm: origtm,
                replyauthor: author,
                replytm: tm,
                msgbody: document.getElementById(`${formName}body`).value
            };

            try {
                const response = await fetch('/reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization' : appState.token
                    },
                    body: JSON.stringify(replyToData)
                });

                if (response.ok) {
                    const j = await response.json();
                    console.log("response ", j);
                    cancelReply(formName);
                } else {
                    const errorMessage = await response.text();
                    console.log(errorMessage);
                    alert(`Error: ${errorMessage}`);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function reply(author, tm, origauthor, origtm) {
            divName = `replydiv${author}${tm}`;
            div = document.getElementById(divName);
            if (!(div === null || div === undefined)) {
                console.log(`cancelling reply ${divName}`);
                cancelReply(divName);
                return;
            }
            rowDivName = `replyrow${author}${tm}`;
            rowDiv = document.getElementById(rowDivName);
            console.log(`reply() rowDivName=${rowDivName} rowDiv=${rowDiv}`);
            formName = `replyform${author}${tm}`;
            html = `<div id="${divName}" class="col">`;
            html += `<div class="col-10"><form class="container-fluid" name="${formName}" id="${formName}">`;
            html += '<div class="row">';
            // html += `<label class="col-1 form-label">Reply:</label>
            html += `<input class="ms-2 col-6 form-control" id="${formName}body">`;
            html += '</div>';
            html += `<div class="row"><button type="button" onclick="postReply('${author}', ${tm}, '${origauthor}', ${origtm})" class="col-3 btn btn-sm btn-primary">Post</button>`;
            html += `<button type="button" class="col-3 btn btn-sm btn-secondary" onclick="cancelReply('${divName}')">Cancel</button></div>`;
            html += '<div id="replyresponse"></div>';
            html += '</form></div></div>';
            rowDiv.innerHTML = html;            
        }
        

        function cancelReply(divName) {
            console.log("cancelReply divName='", divName);
            div = document.getElementById(divName);
            div.remove();
        }

        async function postNew() {
            text = document.getElementById("newPostText").value;
            try {
                const response = await fetch('/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                        'Authorization' : appState.token
                    },
                    body: text
                });

                if (response.ok) {
                    console.log("postNew reponse OK");
                    const resp = await response.json();
                    console.log("postNew server response", resp);
                    msg = { author:appState.username, tm:resp.tm, body:text, numreplies:0};
                    mergeFeed([msg]);
                    await renderFeed();
                    
                    // insert the post into the feed
                    // feed = [j].concat(feed);
                    // await renderFeed();
                } else {
                    const errorMessage = await response.text();
                    console.log(errorMessage);
                    alert(`Error: ${errorMessage}`);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        };

        async function register() {

        }

        function formatTimestamp(ts) {
            const diffTimeSec = (Date.now()-ts) / 1000;
            const diffMinutes = diffTimeSec / 60
            const diffHours = diffMinutes / 60
            const diffDays = diffHours / 24;
            const diffWeeks = diffDays / 7;    
            // console.log(`weeks days hours minutes seconds ${diffWeeks} ${diffDays} ${diffHours} ${diffMinutes} ${diffTimeSec}`);
            if (Math.floor(diffWeeks) > 0) {
                return `${Math.floor(diffWeeks)} weeks`
            } else if (Math.floor(diffDays) > 0) {
                return `${Math.floor(diffDays)} days`
            } else if (Math.floor(diffHours) > 0) {
                return `${Math.floor(diffHours)} hrs`
            } else if (Math.floor(diffMinutes) > 0) {
                return `${Math.round(diffMinutes)} min`
            } else {
                return `${Math.round(diffTimeSec)} sec`
            }   
        }

        function renderMessage(m, origauthor, origtm) {
            const id = `${m.author}${m.tm}`;
            let x = `<div id="${id}" class="mb-3 mt-3 row container">`;
            x += `<div class="row">`;
            x += `  <span class="col"><h5>${m.author}</h5></span>`;
            x += `  <span class="col">${formatTimestamp(m.tm)}</span>`;
            x += `</div>`;
            x += '<div class="row">';
            x += `  <div class="col-auto mb-3 mt-3">${m.body}</div>`;
            x += '</div>';
            x += `<div class="row justify-content-between">`;
            // reply button
            x += `  <span class="col-2"><button type="button" class="btn btn-outline-info" data-bs-toggle="button"`;
            x += `       onclick="reply('${m.author}', ${m.tm}, '${origauthor}', ${origtm})">Reply</button></span>`;
            // vote buttons 
            x += '  <span class="col-2">'; 
            x += `     <span class="container-fluid"><button type="button" class="btn btn-outline-success">^</button>`;
            x += '          <button type="button" class="btn btn-outline-danger">v</button>';
            x += '     </span>';
            x += '  </span>';
            x += '</div>';
            x += `<div class="row" id="replyrow${m.author}${m.tm}"></div>`;
            x += '<div class="row mt-2">';
            x += `<span class="col-2">${m.numreplies} replies</span>`;
            x += `<span class="col-2"><button class="btn btn-sm btn-outline-light" data-bs-toggle="button">Show</button></span>`;
            x += '</div>';
            if (!m.replies === undefined && !m.replies == null && m.replies.length > 0) {
                replies.forEach( (r) => {
                    x += renderMessage(r, origauthor, origtm);
                });
            }
            x += '</div></div>';
            return x;
        }
        
        async function renderFeed() {
            console.log("renderFeed new messages=", appState.newMessages.length);
            feedHTML = "";
            while(appState.newMessages.length > 0) {
                m = appState.newMessages.pop();
                feedHTML += renderMessage(m, m.author, m.tm);
                m.needsRender = false;
            }            
            // prepend
            if (!appState.firstRender)
                feedHTML += document.getElementById("feed").innerHTML;
            appState.firstRender = false;
            document.getElementById("feed").innerHTML = feedHTML;
        }

        function updateMessage(oldMsg, newMsg) {
            console.log("updateMessage oldMsg=", oldMsg, "newMsg=", newMsg);
            if (newMsg.hasOwnProperty("body") && oldMsg.body != newMsg.body) {
                m.needsRender = true;
                oldMsg.body = newMsg.body;
            }
            if (newMsg.hasOwnProperty("score") && oldMsg.score != newMsg.score) {
                m.needsRender = true;
                oldMsg.score = newMsg.score;
            }
            if (newMsg.hasOwnProperty("numreplies") && oldMsg.body != newMsg.score) {
                m.needsRender = true;
                oldMsg.numreplies = newMsg.numreplies;
            }
        }

        function mergeFeed(messages) {
            for (m of messages) {
                key = m.author + m.tm;
                if (appState.feedMap.has(key)) {
                    idx = appState.feedMap.get(key);
                    console.log("mergeFeed idx=", idx);
                    updateMessage(appState.feed[idx], m);
                } else {
                    appState.feedMap.set(key, appState.feed.push(m) - 1);
                    m.needsRender = true;
                    appState.newMessages.push(m);
                }                
            }
        }

        async function getFeed() {
            console.log("getFeed");

            try {
                const response = await fetch(`/feed?lastupdate=${appState.lastupdate}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization' : appState.token
                    }
                });

                if (response.ok) {
                    console.log("getFeed response OK")
                    const j = await response.json();
                    mergeFeed(j.feed);
                    await renderFeed();
                    appState.lastupdate = j.lastupdate;
                } else {
                    const errorMessage = await response.text();
                    console.log(errorMessage);
                }
            } catch (error) {
                console.error('Error:', error);
            }

            setTimeout("getFeed()", 10000);
        }

        async function renderUserList() {
            // html = '<ul>'; //  class="list-group"
            let html = '<div class="container-fluid">';
            for (u of appState.userList) { // list-group-item
                // html += `<li style="background-color: yellow" class=" container-fluid  justify-content-end" style="background-color: red">';
                html += '<div class="row mb-3 justify-content-between border-top border-right">';
                html += `<span class="col-1 border-left">${u.username}</span>`; 
                html += `<span class="col-1"><button class="btn btn-secondary" click="subscribe(${u.username})">sub</button></span>`;
                html += '</div>';
                // html += '</li>';
            }
            html += "</div>";
            // html += "</ul>";
            document.getElementById("users").innerHTML = html;
        }
        async function getUserList() {
            console.log("getUsers");

            try {
                const response = await fetch(`/users`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization' : appState.token
                    }
                });

                if (response.ok) {
                    console.log("getUsers response OK")
                    const j = await response.json();
                    appState.userList = j;
                    await renderUserList();
                } else {
                    const errorMessage = await response.text();
                    console.log(errorMessage);
                    alert(`Error: ${errorMessage}`);
                }
            } catch (error) {
                console.error('Error:', error);
            }

            setTimeout("getUserList()", 30000);
        }
    </script>
</body>
</html>
